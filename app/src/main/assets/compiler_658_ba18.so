# Generador Nequi - ULTRA LIMPIO Y SIMPLE
import os
import sys
from PIL import Image, ImageDraw, ImageFont


def generate_nequi_voucher(assets_path, nombre, telefono, monto):
    """Generar comprobante Nequi"""
    print(f"[Nequi] === INICIO GENERACI√ìN ===")
    print(f"[Nequi] Assets: {assets_path}")
    print(f"[Nequi] Nombre: {nombre}")
    print(f"[Nequi] Tel√©fono: {telefono}")
    print(f"[Nequi] Monto: {monto}")
    
    # A√±adir assets al path
    if assets_path not in sys.path:
        sys.path.insert(0, assets_path)
        print(f"[Nequi] Path agregado: {assets_path}")
    
    # Limpiar imports previos
    for mod in ['config_nequi', 'utils_nequi']:
        if mod in sys.modules:
            del sys.modules[mod]
            print(f"[Nequi] M√≥dulo limpiado: {mod}")
    
    # Importar
    import config_nequi
    import utils_nequi
    print(f"[Nequi] M√≥dulos importados OK")
    
    cfg = config_nequi.COMPROBANTE_NEQUI_CONFIG
    
    # Abrir plantilla en MODO ULTRA CALIDAD SUPREMA
    template_path = os.path.join(assets_path, cfg['template'])
    print(f"[Nequi] Buscando plantilla: {template_path}")
    print(f"[Nequi] ¬øExiste plantilla? {os.path.exists(template_path)}")
    
    # Abrir JPG con m√°xima calidad, sin subsampling
    img = Image.open(template_path)
    
    # Convertir a RGB de m√°xima calidad si es necesario
    if img.mode != 'RGB':
        img = img.convert('RGB')
    
    # ULTRA MEGA 4K: Escalar plantilla 2x con LANCZOS (algoritmo premium)
    original_size = img.size
    img = img.resize(
        (original_size[0] * 2, original_size[1] * 2), 
        Image.Resampling.LANCZOS  # M√°xima calidad de escalado
    )
    
    # Aplicar SHARPEN para aumentar nitidez de la plantilla
    from PIL import ImageFilter, ImageEnhance
    img = img.filter(ImageFilter.SHARPEN)
    
    # Aumentar ligeramente el contraste para mayor claridad
    enhancer = ImageEnhance.Contrast(img)
    img = enhancer.enhance(1.05)  # +5% contraste para mayor definici√≥n
    
    draw = ImageDraw.Draw(img)
    print(f"[Nequi] ‚úÖ Plantilla ULTRA 4K MEJORADA: {img.size[0]}x{img.size[1]} (2x + sharpened)")
    
    # Preparar datos EN ORDEN ESPEC√çFICO
    data = [
        ("nombre", str(nombre)),
        ("valor", utils_nequi.format_currency(monto)),
        ("telefono", utils_nequi.format_phone(telefono)),
        ("fecha", utils_nequi.get_date()),
        ("referencia", utils_nequi.get_reference()),
        ("disponible", "Disponible")
    ]
    
    # Cargar fuente 20px (tama√±o fijo, NO escalado)
    font_path = os.path.join(assets_path, cfg['font'])
    print(f"[Nequi] Buscando fuente: {font_path}")
    print(f"[Nequi] ¬øExiste fuente? {os.path.exists(font_path)}")
    
    # Tama√±o 2x SOLO para la fuente (porque la imagen est√° escalada 2x)
    font_size_scaled = cfg['font_size'] * 2  # 20 * 2 = 40px para imagen 2x
    font = ImageFont.truetype(font_path, font_size_scaled)
    print(f"[Nequi] ‚úÖ Fuente: {cfg['font_size']}px (escalada a {font_size_scaled}px para imagen 2x)")
    
    # Dibujar textos con coordenadas escaladas 2x
    print(f"[Nequi] === DIBUJANDO TEXTOS ===")
    for field, text in data:
        if field in cfg['fields']:
            # Coordenadas 2x para imagen escalada
            orig_pos = cfg['fields'][field]
            pos = (orig_pos[0] * 2, orig_pos[1] * 2)
            # Dibujar texto
            draw.text(pos, text, font=font, fill=cfg['color'])
            print(f"[Nequi] ‚úì {field}: '{text}' en coordenadas originales {orig_pos}")
        else:
            print(f"[Nequi] ‚úó CAMPO NO ENCONTRADO: {field}")
    
    # Guardar PNG ULTRA MEGA 4K - M√ÅXIMA CALIDAD SUPREMA
    output_path = os.path.join(assets_path, cfg['output'])
    img.save(
        output_path, 
        'PNG',
        optimize=False,           # Sin optimizaci√≥n
        compress_level=0,         # SIN COMPRESI√ìN = ULTRA CALIDAD
        icc_profile=None,         # Sin perfil
        dpi=(600, 600)            # 600 DPI = ULTRA MEGA 4K
    )
    
    file_size = os.path.getsize(output_path) if os.path.exists(output_path) else 0
    print(f"[Nequi] === FIN GENERACI√ìN ULTRA MEGA 4K ===")
    print(f"[Nequi] ‚úÖ Guardado: {output_path}")
    print(f"[Nequi] ‚úÖ Tama√±o: {file_size} bytes")
    print(f"[Nequi] ‚úÖ Resoluci√≥n: {img.size[0]}x{img.size[1]} @ 600 DPI")
    print(f"[Nequi] üöÄ ULTRA MEGA 4K SUPREMA ACTIVADA")
    
    return output_path


def generate_from_assets(assets_path, nombre, telefono, monto, config_name=None):
    """Wrapper para VoucherActivity"""
    print(f"[Nequi] generate_from_assets llamado con:")
    print(f"  - assets_path: {assets_path}")
    print(f"  - nombre: {nombre}")
    print(f"  - telefono: {telefono}")
    print(f"  - monto: {monto}")
    print(f"  - config_name: {config_name}")
    return generate_nequi_voucher(assets_path, nombre, telefono, monto)
