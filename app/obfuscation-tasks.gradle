// ===================================================================
// TAREAS DE OFUSCACIÃ“N AUTOMÃTICA ULTRA EXTREMA
// Se ejecutan automÃ¡ticamente antes del build release
// ===================================================================

// ðŸ”’ðŸ”’ðŸ”’ TAREA 1: ENCRIPTAR LAYOUTS (ConversiÃ³n a SMALI)
task encryptLayouts(type: Exec) {
    group = 'obfuscation'
    description = 'ðŸ”’ Encripta layouts XML a assets - Solo SMALI visible en APKTool'
    
    workingDir projectDir
    
    // Detectar Python disponible
    def pythonCmd = System.getProperty('os.name').toLowerCase().contains('windows') ? 'python' : 'python3'
    
    commandLine pythonCmd, 'encrypt-layouts.py'
    
    doFirst {
        println ""
        println "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        println "â•‘  ðŸ”’ðŸ”’ðŸ”’ ENCRIPTACIÃ“N ULTRA EXTREMA ACTIVADA ðŸ”’ðŸ”’ðŸ”’            â•‘"
        println "â•‘                                                               â•‘"
        println "â•‘  Convirtiendo layouts XML a formato SMALI Ãºnicamente         â•‘"
        println "â•‘  APKTool NO podrÃ¡ ver los layouts reales                     â•‘"
        println "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        println ""
    }
    
    doLast {
        println ""
        println "âœ… Layouts convertidos a SMALI + encriptados"
        println "âœ… APKTool solo verÃ¡ cÃ³digo ofuscado"
        println ""
    }
    
    ignoreExitValue = true
}

// ðŸ”’ TAREA 2: OFUSCAR LAYOUTS (IDs y estructura)
task obfuscateLayouts(type: Exec) {
    group = 'obfuscation'
    description = 'Ofusca IDs y estructura de layouts dummy'
    
    workingDir projectDir
    
    def pythonCmd = System.getProperty('os.name').toLowerCase().contains('windows') ? 'python' : 'python3'
    
    commandLine pythonCmd, 'obfuscate-xml.py'
    
    doFirst {
        println "ðŸ”’ Ofuscando layouts dummy..."
    }
    
    doLast {
        println "âœ… Layouts dummy ofuscados"
    }
    
    ignoreExitValue = true
}

// ðŸ”¥ðŸ”¥ðŸ”¥ TAREA 3: CREAR LAYOUTS TRAMPA (Romper APKTool)
task createTrapLayouts(type: Exec) {
    group = 'obfuscation'
    description = 'ðŸ”¥ Crea layouts trampa que ROMPEN APKTool cuando descompilan'
    
    workingDir projectDir
    
    def pythonCmd = System.getProperty('os.name').toLowerCase().contains('windows') ? 'python' : 'python3'
    
    commandLine pythonCmd, 'create-trap-layouts.py'
    
    doFirst {
        println ""
        println "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        println "â•‘  ðŸ”¥ðŸ”¥ðŸ”¥ CREANDO LAYOUTS TRAMPA ðŸ”¥ðŸ”¥ðŸ”¥                          â•‘"
        println "â•‘                                                               â•‘"
        println "â•‘  APKTool SE ROMPERÃ cuando intenten descompilar              â•‘"
        println "â•‘  Solo verÃ¡n 3-5 layouts - los demÃ¡s causarÃ¡n ERRORES        â•‘"
        println "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        println ""
    }
    
    doLast {
        println ""
        println "âœ… Layouts trampa creados - APKTool sufrirÃ¡ ðŸ˜ˆ"
        println ""
    }
    
    ignoreExitValue = true
}

// Tarea para ofuscar strings.xml y otros recursos values
task obfuscateStrings {
    group = 'obfuscation'
    description = 'Ofusca strings y valores de resources'
    
    doLast {
        println "ðŸ”’ Ofuscando strings.xml..."
        
        def valuesDir = file("src/main/res/values")
        if (valuesDir.exists()) {
            valuesDir.listFiles().each { file ->
                if (file.name.endsWith('.xml') && file.name != 'public.xml') {
                    def content = file.text
                    
                    // Remover comentarios XML
                    content = content.replaceAll(/<!--.*?-->/, '')
                    
                    // Minimizar whitespace
                    content = content.replaceAll(/\n\s+/, '\n')
                    content = content.replaceAll(/>\s+</, '><')
                    
                    file.text = content
                }
            }
            println "âœ… Strings ofuscados"
        }
    }
}

// Tarea para remover recursos no usados antes del shrinking
task removeUnusedResources {
    group = 'obfuscation'
    description = 'Remueve recursos XML no utilizados'
    
    doLast {
        println "ðŸ”’ Analizando recursos no utilizados..."
        // Esta tarea se complementa con shrinkResources = true
        println "âœ… Configurado para remover recursos automÃ¡ticamente"
    }
}

// Tarea maestra que ejecuta todas las ofuscaciones
task obfuscateAll {
    group = 'obfuscation'
    description = 'Ejecuta TODAS las ofuscaciones ultra extremas + layouts trampa'
    
    dependsOn createTrapLayouts, encryptLayouts, obfuscateLayouts, obfuscateStrings, removeUnusedResources
    
    doFirst {
        println ""
        println "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        println "â•‘                                                               â•‘"
        println "â•‘     ðŸ”’ðŸ”’ðŸ”’ PROTECCIÃ“N ULTRA EXTREMA ACTIVADA ðŸ”’ðŸ”’ðŸ”’            â•‘"
        println "â•‘                                                               â•‘"
        println "â•‘  âœ“ ðŸ”¥ LAYOUTS TRAMPA que rompen APKTool                      â•‘"
        println "â•‘  âœ“ EncriptaciÃ³n de layouts (ConversiÃ³n a SMALI)             â•‘"
        println "â•‘  âœ“ OfuscaciÃ³n de layouts dummy                               â•‘"
        println "â•‘  âœ“ OfuscaciÃ³n de strings y valores                           â•‘"
        println "â•‘  âœ“ RemociÃ³n de recursos no usados                            â•‘"
        println "â•‘  âœ“ OfuscaciÃ³n de cÃ³digo con ProGuard                         â•‘"
        println "â•‘  âœ“ ProtecciÃ³n anti-ingenierÃ­a inversa                        â•‘"
        println "â•‘  âœ“ Solo 3-5 layouts visibles - demÃ¡s rompen APKTool         â•‘"
        println "â•‘                                                               â•‘"
        println "â•‘  âš ï¸  ADVERTENCIA: Estos cambios son IRREVERSIBLES            â•‘"
        println "â•‘      AsegÃºrate de tener backup del cÃ³digo fuente             â•‘"
        println "â•‘      APKTool NO podrÃ¡ ver los layouts reales                 â•‘"
        println "â•‘                                                               â•‘"
        println "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        println ""
    }
    
    doLast {
        println ""
        println "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        println "â•‘  âœ… PROTECCIÃ“N ULTRA EXTREMA COMPLETADA âœ…                    â•‘"
        println "â•‘                                                               â•‘"
        println "â•‘  Tu APK ahora tiene protecciÃ³n nivel MÃXIMO contra:          â•‘"
        println "â•‘  â€¢ ðŸ”¥ APKTool: SE ROMPERÃ al descompilar                     â•‘"
        println "â•‘  â€¢ ðŸ”¥ Solo 3-5 layouts visibles, demÃ¡s causan ERROR          â•‘"
        println "â•‘  â€¢ Layouts trampa: Referencias circulares infinitas         â•‘"
        println "â•‘  â€¢ Encoding corrupto: Parsers crashean                       â•‘"
        println "â•‘  â€¢ Layouts gigantes: APKTool MUY lento o crash               â•‘"
        println "â•‘  â€¢ CÃ³digo: Ofuscado a nivel extremo                          â•‘"
        println "â•‘  â€¢ IAs: No pueden reconstruir la UI                          â•‘"
        println "â•‘                                                               â•‘"
        println "â•‘  ðŸŽ¯ RESULTADO:                                                â•‘"
        println "â•‘     Cuando descompilen con APKTool:                          â•‘"
        println "â•‘     âœ— res/layout/ = ~35 layouts trampa + 3-5 reales         â•‘"
        println "â•‘     âœ— APKTool crashea o tarda horas procesando              â•‘"
        println "â•‘     âœ— Referencias circulares = loop infinito                â•‘"
        println "â•‘     âœ— XMLs corruptos = parser error                         â•‘"
        println "â•‘     âœ“ smali/ = CÃ³digo ofuscado (ilegible)                   â•‘"
        println "â•‘                                                               â•‘"
        println "â•‘  ðŸ”¥ Â¡APKTool SUFRIRÃ intentando descompilar! ðŸ˜ˆ              â•‘"
        println "â•‘                                                               â•‘"
        println "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        println ""
    }
}

// INTEGRACIÃ“N AUTOMÃTICA: Ejecutar ofuscaciÃ³n antes de builds release
// NOTA: Ejecutar manualmente con ./gradlew encryptLayouts antes del build
// La ejecuciÃ³n automÃ¡tica estÃ¡ desactivada por incompatibilidad de APIs de AGP

println """
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ”’ðŸ”’ðŸ”’ Sistema Ultra Extremo CARGADO ðŸ”’ðŸ”’ðŸ”’                  â”‚
â”‚                                                             â”‚
â”‚ PROTECCIÃ“N MULTI-CAPA:                                     â”‚
â”‚  1ï¸âƒ£  ðŸ”¥ Layouts TRAMPA que rompen APKTool                  â”‚
â”‚  2ï¸âƒ£  EncriptaciÃ³n de layouts (AES-256)                     â”‚
â”‚  3ï¸âƒ£  ConversiÃ³n a SMALI (APKTool no verÃ¡ XMLs)            â”‚
â”‚  4ï¸âƒ£  Layouts dummy (confunden atacantes)                   â”‚
â”‚  5ï¸âƒ£  OfuscaciÃ³n de cÃ³digo (ProGuard extremo)              â”‚
â”‚                                                             â”‚
â”‚ âš ï¸  EJECUCIÃ“N MANUAL REQUERIDA:                             â”‚
â”‚                                                             â”‚
â”‚ PASO 1 - Crear layouts trampa (ROMPER APKTool):           â”‚
â”‚   cd app                                                   â”‚
â”‚   python3 create-trap-layouts.py                          â”‚
â”‚                                                             â”‚
â”‚ PASO 2 - (Opcional) Encriptar layouts:                    â”‚
â”‚   pip install pycryptodome                                â”‚
â”‚   python3 encrypt-layouts.py                              â”‚
â”‚                                                             â”‚
â”‚ PASO 3 - Compilar release:                                â”‚
â”‚   cd ..                                                    â”‚
â”‚   ./gradlew assembleRelease                                â”‚
â”‚                                                             â”‚
â”‚ ðŸŽ¯ RESULTADO:                                               â”‚
â”‚   ðŸ”¥ APKTool SE ROMPERÃ con ~35 layouts trampa            â”‚
â”‚   âœ… Solo 3-5 layouts visibles, demÃ¡s ERROR               â”‚
â”‚   âœ… Referencias circulares = loop infinito                â”‚
â”‚   âœ… Â¡APKTool sufrirÃ¡ horas intentando descompilar! ðŸ˜ˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
"""
